---
title: 設計書 (Design Document)
---

# 設計書 (Design Document)

## 1. 概要

Excel VBA を使用して、検査報告書を自動生成するシステムの設計書。

## 2. システム構成

- **入力**:
  - `_input.xlsm`: メインの Excel ブック。
    - `List` シート: 報告書データのリスト。
    - `Settings` シート: 処理に必要な設定値。
    - `TemplateSheet` シート: 報告書のテンプレート。
- **出力**:
  - `dist/` フォルダ:
    - `InspectionReport_*.xlsx`: 生成された検査報告書。
    - `Log.txt`: 処理ログ。
    - `DebugLog.txt`: 詳細なデバッグログ。
- **ソースコード**:
  - `src/bas/`: VBA モジュール。

## 3. モジュール設計

| モジュール名        | 説明                               |
| ------------------- | ---------------------------------- |
| `M01_Main`          | メイン処理の制御                   |
| `M02_Processor`     | データ処理とレポート作成のコアロジック |
| `M03_FileHandler`   | ファイル・ブック・シート操作       |
| `M04_Logger`        | 通常ログの出力                     |
| `M05_Utility`       | 汎用的なユーティリティ関数         |
| `M06_DebugLogger`   | デバッグログの出力                 |

## 3.1. ログ制御機能

本システムでは、ログ出力を動的に制御する機能を提供する。

### ログレベル制御変数
- `M01_Main`モジュール内にログ制御用のモジュールレベル変数を定義
  - `ENABLE_ERROR_LOG As Boolean`: ErrorLogシートへの出力を制御（True=有効, False=無効）
  - `ENABLE_DEBUG_LOG As Boolean`: DebugLogの出力を制御（True=有効, False=無効）

### 制御方法
- 各変数を`True`/`False`に設定することで、該当するログ出力を有効/無効にする
- デフォルトは両方とも`True`（有効）

## 3.2. 入力シート処理機能

本システムでは、「入力」シートに複数の処理対象を一覧で定義し、順次処理する機能を提供する。

### 入力シート構成
- B列: 前回データファイルパス（旧ブック_ファイルパス）
- C列: 旧ブック_新ブック名判定アドレス
- D列: 保存先フォルダパス
- E列: 点検日
- G列: 出力ブック_保存ファイル名

### 処理フロー
1. 入力シートの2行目以降を順次処理（1行目はヘッダー）
2. 各行のデータをSettingsシートのD7:D11に転記
3. 旧ブックから型式を取得してD22に設定
4. XLOOKUP関数の計算完了を待機（最大10回リトライ、0.5秒間隔）
5. 計算完了後、データ移行処理を実行

## 4. データフロー

1.  `M01_Main` の `StartProcess` が処理を開始。
2.  入力シートから処理対象データを1行ずつ読み取り、各行について：
    - `Settings` シートのD7-D11に入力データを転記。
    - XLOOKUP関数による計算完了を待機。
    - `M02_Processor` の `ExecuteAllTasks` でデータ移行処理を実行。
3.  各処理について、`M03_FileHandler` がファイル操作を実行。
4.  `M04_Logger` と `M06_DebugLogger` が随時ログを記録。

## 5. 詳細設計

### M01_Main

#### ログ制御変数
- `ENABLE_ERROR_LOG As Boolean`: ErrorLogシートへの出力制御（デフォルト: True）
- `ENABLE_DEBUG_LOG As Boolean`: DebugLogの出力制御（デフォルト: True）

#### メインプロシージャ
- `StartProcess`: メインプロシージャ。入力シートから処理対象を読み込み、各行を順次処理
- `ProcessInputRow`: 入力シートの1行分を処理する
- `GetValueFromOldBook`: 旧ブックから指定アドレスの値を取得する

### M02_Processor

- `settings` (Private, Dictionary): 設定値を保持するグローバル変数。
- `LoadSettings`: `Settings` シートの C, D 列からキーと値を読み取り、`settings` に格納する。
- `ProcessReports`: `List` シートのデータに基づいてループ処理を行い、`CreateReport` を呼び出す。
- `CreateReport`: `M03_FileHandler` を使ってレポートブックを作成し、データを転記し、保存する。
- `ExecuteAllTasks`: Settingsシートの51行目以降のタスクリストを実行する（開始行を34行目から51行目に変更）

### M03_FileHandler

- `CreateWorkbookFromTemplate`: `TemplateSheetName` を引数に取り、そのシートをコピーして新しいワークブックオブジェクトを返す。
- `SaveWorkbook`: ワークブックオブジェクトとファイル名を引数に取り、`dist/` フォルダに `.xlsx` 形式で保存する。
- `OpenWorkbook`: 指定パスのワークブックを開く（ダイアログ無効化対応）
- `CreateNewBook`: テンプレートをコピーして新しいブックを作成する
- `FileExists`: ファイル存在確認
- `ParseAddress`: アドレス文字列を解析する（正規表現使用、エラーハンドリング強化）
- `OpenFileLocation`: 指定ファイルの保存フォルダをエクスプローラーで開く

### M04_Logger

- `InitializeLogs`: ログシステムを初期化する（メソッド名をInitializeLoggerから変更）
- `WriteLog`: レベル、メッセージ、詳細を引数に取り、タイムスタンプと共に `Log` シートに追記する
- `WriteError`: エラーレベル、シートNo、処理No、エラー内容、詳細を引数に取り、`ErrorLog` シートに追記する
- `CleanupLogs`: ログシステムをクリーンアップする

### M05_Utility

- `GetLastRow`: ワークシートと列番号を引数に取り、最終行の行番号を返す。
- `GetRangeFromAddressString`: アドレス文字列からRangeオブジェクトを取得する

### M06_DebugLogger

- `InitializeDebugLog`: デバッグログシステムを初期化する
- `WriteDebugLog`: モジュール名、プロシージャ名、メッセージを引数に取り、詳細なデバッグ情報を `DebugLog.txt` に追記する
- `CleanupDebugLog`: デバッグログシステムをクリーンアップする

## ログ仕様

本システムは、処理の進行状況やエラーを追跡するために2種類のログを出力する。

### 1. 通常ログ (Logシート)

- **目的**: ユーザーが処理の主要な流れを把握するため。
- **出力内容**: 処理の開始・終了、生成されたファイル名など、主要なイベント。
- **出力場所**: Excelブック内の `Log` シート。
- **実装**: `M04_Logger` モジュールの `WriteLog` プロシージャを使用する。

### 2. エラーログ (ErrorLogシート)

- **目的**: エラーや警告の詳細情報を記録し、問題解決に役立てるため。
- **出力内容**: エラーレベル、処理シートNo、処理No、エラー内容、詳細説明。
- **出力場所**: Excelブック内の `ErrorLog` シート。
- **実装**: `M04_Logger` モジュールの `WriteError` プロシージャを使用する。

### 3. デバッグログ (DebugLogシート)

- **目的**: 開発者が詳細な処理内容を確認し、問題解決（デバッグ）に役立てるため。
- **出力内容**:
    - 各プロシージャ・関数の開始と終了。
    - 受け渡された引数の値。
    - ループ内のカウンターや重要な変数の値。
    - ファイル操作やシート操作の直前のパラメータ。
    - 設定ファイルから読み込んだキーと値のペア。
- **出力場所**: Excelブック内の `DebugLog` シート。
- **実装**: `M06_DebugLogger` モジュールの `WriteDebugLog` プロシージャを使用する。
- **フォーマット**: `[Debug] - <モジュール名> - <プロシージャ名> - <メッセージ>`

---

## 著作権と免責事項

| ドキュメント名 | 点検報告書 旧データ移行ツール 設計書 |
| :--- | :--- |
| バージョン | 1.3 |
| 作成日 | 2025年7月5日 |
| 作成者 | (あなたのためのVBAプロフェッショナル) |
| 承認者 | (お客様名) |

---

### **1. 概要**

本設計書は、「点検報告書 旧データ移行ツール 仕様書 Ver.1.1」で定義された要件を実現するための、技術的な実装方法を定義するものである。VBAのモジュール構成、各機能の実装ロジック、およびエラーハンドリングの具体的な手法について詳述する。

### **2. システムアーキテクチャ**

#### **2.1. Excelブックとシート構成**

本ツール（以下、マクロブック）は、以下のシートで構成される。

-   **`Control`**: ユーザーインターフェースシート。マクロ実行ボタンを配置する。
-   **`Settings`**: 処理設定シート。ユーザーが処理内容を定義する。
-   **`List`**: テンプレートファイルのマスタリストシート。
-   **`Log`**: 処理ログ出力シート。
-   **`Error`**: エラーログ出力シート。
-   **`DebugLog`**: デバッグログ出力シート。開発時のみ使用する。

#### **2.2. VBAプロジェクト構成**

VBAコードは機能ごとにモジュールを分割し、保守性と可読性を高める。

-   **`M01_Main`**: メインコントローラー。
-   **`M02_Processor`**: データ処理のコアロジック。
-   **`M03_FileHandler`**: ファイル操作関連。
-   **`M04_Logger`**: `Log`および`Error`シートへの書き込み処理。
-   **`M05_Utility`**: 汎用的な便利機能。
-   **`M06_DebugLogger`**: `DebugLog`シートへの書き込み処理。

### **3. デバッグ機能**

#### **3.1. デバッグモード**

-   `M06_DebugLogger`モジュール内の定数 `IS_DEBUG_MODE` を `True` に設定することで、デバッグモードが有効になる。
-   デバッグモードが有効の場合、`DebugLog`シートに処理の詳細なログが日本語で出力される。
-   `IS_DEBUG_MODE` を `False` に設定すると、デバッグログの出力はすべて抑制され、パフォーマンスへの影響をなくすことができる。

### **4. VBAモジュール詳細設計**

#### **4.1. Settingsシート**

`Settings`シートは、マクロの動作を制御するための設定情報を保持する。特に、以下のセルはVBAコードによって参照される。

-   `旧ブック_ファイルパス` (D7): 処理対象となる旧報告書のフルパス。
-   `旧ブック_新ブック名判定アドレス` (D8): 新報告書の種類を特定するための、旧報告書内のセルアドレス。
-   `出力ブック_保存先フォルダ` (D9): 作成される新報告書の保存先フォルダのフルパス。このセルが空白の場合、VBA実行中のExcelファイルと同じフォルダが使用される。

(各モジュールの詳細設計は、コード内のコメントに記載の通り)

---
- **著作権**: このVBAプログラムの著作権は作成者に帰属します。
- **免責事項**: このプログラムの使用によって生じたいかなる損害についても、作成者は責任を負いません。自己責任でご使用ください。
