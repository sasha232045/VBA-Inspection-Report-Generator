### **【成果物2/3】 仕様書 (Specification Document)**

これは、ツールが「何を」すべきかを定義する、要件をまとめたドキュメントです。

---

**文書管理**

| ドキュメント名 | 点検報告書 旧データ移行ツール 仕様書 |
| :--- | :--- |
| バージョン | 1.0 |
| 作成日 | 2025年7月5日 |
| 作成者 | (あなたのためのVBAプロフェッショナル) |
| 承認者 | (お客様名) |

---

### **1. 概要**

本仕様書は、「点検報告書 旧データ移行ツール」（以下、本ツール）が持つべき機能および動作に関する要件を定義するものである。本ツールは、指定された旧点検報告書ファイルからデータを抽出し、指定されたルールに基づき、テンプレートから作成した新点検報告書ファイルへデータを移行するプロセスを自動化することを目的とする。

### **2. 機能要件**

#### **2.1. 設定情報管理機能**

本ツールは、処理内容を定義する設定情報をExcelシート上で管理する。

-   **2.1.1. `Settings`シート**
    -   ユーザーは本シートに処理の全体設定と詳細なステップを定義する。
    -   **全体設定 (B2:D13)**
        -   `旧ブック_ファイルパス` (D2): 処理対象となる旧報告書のフルパスを指定する。
        -   `旧ブック_新ブック名判定アドレス` (D3): 新報告書の種類を特定するために参照する、旧報告書内のセルアドレス（例：`'シート名'!A1`）を指定する。
        -   その他、ファイルパスから自動抽出される情報（旧ブック_ファイル名、単価契約明細NO等）を表示する領域を持つ。これらの値は、マクロ処理では直接使用しないが、ユーザーの確認用として数式で自動表示される。
        -   `新ブック_ファイルパス` (D10): 後述の2.2.1項のロジックに基づき、使用されるテンプレートのパスを自動で表示する。
    -   **処理詳細設定 (A15以降)**
        -   1行を1つの処理ステップとする。
        -   各行は以下の列で構成される。
            -   `処理シートNo`: 処理をグループ化するための番号。同一Noは一連の処理と見なす。
            -   `処理No.`: グループ内での処理順序（参考情報であり、マクロの動作順序には影響しない）。
            -   `処理内容`: `旧ブック_シート名`, `新ブック_シート名`, `旧ブック_コピー元アドレス`, `新ブック_コピー先アドレス`, `新ブック_削除するアドレス`, `新ブック_入力するアドレス`, `新ブック_入力する内容` のいずれかを指定する。
            -   `内容`: `処理内容`に対応する具体的な値（シート名、セルアドレス等）を記述する。
-   **2.1.2. `List`シート**
    -   報告書の種類を定義するマスタデータシート。
    -   各行は以下の主要な列で構成される。
        -   `判断結果`: キーとなる報告書の種類名（例: `日新Cub-123TrB`）。これは、旧報告書の`旧ブック_新ブック名判定アドレス`から取得した値と一致させるために使用する。
        -   `ファイルパス`: `判断結果`に対応する、新報告書の元となるテンプレートファイルのフルパス。

#### **2.2. 新ブック作成機能**

-   **2.2.1. 動的テンプレート選択**
    1.  `Settings`シート(D2)の`旧ブック_ファイルパス`で指定された旧ブックを開く。
    2.  旧ブック内の`Settings`シート(D3)で指定された`旧ブック_新ブック名判定アドレス`のセルの値を取得する。
    3.  `List`シートの`判断結果`列を検索し、2.で取得した値と一致する行を見つける。
    4.  一致した行の`ファイルパス`列から、使用すべきテンプレートファイルのパスを取得する。このパスを`Settings`シート(D10)の`新ブック_ファイルパス`セルに表示する。
-   **2.2.2. 新ブックの生成**
    1.  2.2.1で特定したテンプレートファイルをコピーする。
    2.  コピーしたファイルのファイル名を、旧ブックのファイル名から日付部分などを変更した、新しい命名規則のファイル名に変更して保存する。（注: 新しいファイル名は現在`D10`のパスに含まれているものをそのまま使用する想定）

#### **2.3. データ操作機能**

`Settings`シートの`A16`行以降に定義されたルールに基づき、`処理シートNo`の昇順でデータ操作を実行する。

-   **2.3.1. コピー処理**
    -   指定された旧ブックの`旧ブック_シート名`にある`旧ブック_コピー元アドレス`の範囲をコピーする。
    -   新ブックの`新ブック_シート名`にある`新ブック_コピー先アドレス`のセルを起点に、「すべて貼り付け（`PasteAll`）」を実行する。値、数式、書式、結合されたセルなど、すべてをそのままコピーする。
-   **2.3.2. 削除処理**
    -   新ブックの指定シートにある`新ブック_削除するアドレス`で指定されたセルの内容を削除（`ClearContents`）する。
    -   アドレスは、単一セル（例: `A1`）、範囲（例: `A1:B10`）、複数範囲（例: `A1,B5,C10:D12`）の形式に対応する。
    -   対象セルが結合されている場合でも、エラーなく内容の削除を実行する。
-   **2.3.3. 入力処理**
    -   新ブックの指定シートにある`新ブック_入力するアドレス`で指定された各セルに、`新ブック_入力する内容`で指定された値を入力する。
    -   アドレスは、削除処理と同様に複数範囲の形式に対応する。複数セルに同一内容を入力する場合、`入力するアドレス`にカンマ区切りでセルを列挙する。

#### **2.4. ログ・エラー出力機能**

-   **2.4.1. ログ出力 (`Log`シート)**
    -   マクロ実行時に、まず`Log`シートの内容をクリアする。
    -   実行された主要な処理ステップごとに、日時、処理内容、対象、結果（成功）を記録する。
    -   例: `2025/07/05 10:00:15 | INFO | コピー処理開始 | 旧: '統一表紙'!A4:CH62 -> 新: '共通(77kV以下)'!A4 | 成功`
-   **2.4.2. エラー出力 (`Error`シート)**
    -   マクロ実行時に、まず`Error`シートの内容をクリアする。
    -   処理中にエラーが発生した場合、処理を中断せず、次のステップへ進む。
    -   発生したエラーについて、日時、エラーが発生した処理内容、エラー番号、エラー詳細を`Error`シートに記録する。
    -   例: `2025/07/05 10:00:20 | ERROR | シート名の取得 | 指定されたシート '存在しないシート' が見つかりません。 | Error 9: Subscript out of range`

### **3. 非機能要件**

-   **3.1. 信頼性**
    -   途中でエラーが発生しても、可能な限り処理を継続し、全ての処理命令を試みること。
    -   処理結果は、ログおよびエラーシートによって追跡可能であること。
-   **3.2. 運用・保守性**
    -   処理ルールの変更は、VBAコードを編集せず、「Settings」および「List」シートの編集のみで対応可能であること。
    -   コードは適切にモジュール分割され、可読性が高く、将来的な機能拡張が容易であること。

---
