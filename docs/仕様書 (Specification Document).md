### **【成果物2/3】 仕様書 (Specification Document)**

これは、ツールが「何を」すべきかを定義する、要件をまとめたドキュメントです。

---

**文書管理**

| ドキュメント名 | 点検報告書 旧データ移行ツール 仕様書 |
| :--- | :--- |
| バージョン | 1.1 |
| 作成日 | 2025年7月5日 |
| 作成者 | (あなたのためのVBAプロフェッショナル) |
| 承認者 | (お客様名) |

---

### **1. 概要**

本仕様書は、「点検報告書 旧データ移行ツール」（以下、本ツール）が持つべき機能および動作に関する要件を定義するものである。本ツールは、指定された旧点検報告書ファイルからデータを抽出し、指定されたルールに基づき、テンプレートから作成した新点検報告書ファイルへデータを移行するプロセスを自動化することを目的とする。

### **2. 機能要件**

#### **2.1. 設定情報管理機能**

本ツールは、処理内容を定義する設定情報をExcelシート上で管理する。

##### **2.1.1. `入力`シート**
-   ユーザーは本シートに処理対象となるファイルリストを定義する。
-   **列構成**
    -   `B列: 前回データファイルパス` - 処理対象となる旧報告書のフルパス
    -   `C列: 旧ブック_新ブック名判定アドレス` - 新報告書の種類を特定するために参照する、旧報告書内のセルアドレス
    -   `D列: 保存先フォルダパス` - 作成される新報告書の保存先フォルダのフルパス
    -   `E列: 点検日` - 点検日
    -   `G列: 出力ブック_保存ファイル名` - 出力ファイル名

##### **2.1.2. `Settings`シート**
    -   ユーザーは本シートに処理の全体設定と詳細なステップを定義する。シートは大きく3つのステップで構成される。
    -   **ステップ1：処理対象の設定**
        -   `旧ブック_ファイルパス` (D7): ユーザーが処理対象となる旧報告書のフルパスを入力する。
        -   `旧ブック_新ブック名判定アドレス` (D8): 新報告書の種類を特定するために参照する、旧報告書内のセルアドレス（例：`'87'!T7:AB7`）を入力する。
        -   `出力ブック_保存先フォルダ` (D9): 作成される新報告書の保存先フォルダのフルパスを入力する。空白の場合、本ツールと同じフォルダに保存される。
    -   **ステップ2：設定内容の自動確認**
        -   `D17`～`D26`のセル範囲には、Excelの数式が予め埋め込まれており、ステップ1で入力された情報に基づき、関連情報が自動で表示される。
        -   `型式` (D22): マクロが旧ブックを開き、`D8`のアdレスから取得した値を表示する。
        -   `種類` (D23): `D22`の「型式」をキーに`List`シートを検索し、該当する種類名を自動で表示する。
        -   `新ブック_ファイルパス` (D24): `D23`の「種類」をキーに`List`シートを検索し、該当するテンプレートパスを自動で表示する。
        -   これらの自動表示項目は、ユーザーが設定内容を視覚的に確認するためのものであり、VBAでのコーディングは不要。
    -   **ステップ3：処理内容の定義 (A34以降)**
        -   1行を1つの処理ステップとし、マクロはここに定義された順序でデータ移行処理を実行する。
        -   各行は以下の列で構成される。
            -   `シートNo`: 処理をグループ化するための番号。同一Noは一連の処理と見なす。
            -   `処理No.`: グループ内での処理順序。
            -   `処理内容`: `旧ブック_シート名`, `新ブック_シート名`, `旧ブック_コピー元アドレス`, `新ブック_コピー先アドレス`, `新ブック_削除するアドレス`, `新ブック_入力するアドレス`, `新ブック_入力する内容` のいずれかを指定する。
            -   `内容`: `処理内容`に対応する具体的な値（シート名、セルアドレス等）を記述する。
-   **2.1.2. `List`シート**
    -   報告書の種類とテンプレートファイルを管理するマスタデータシート。UXを考慮し、意図的に空白列が設けられている。
    -   各行は以下の主要な列で構成される。
        -   `種類` (F列): キーとなる報告書の種類名（例: `日新Cub-123TrB`）。これは、旧報告書の`旧ブック_新ブック名判定アドレス`から取得した値と照合するために使用する。
        -   `ファイルパス` (G列): `種類`に対応する、新報告書の元となるテンプレートファイルのフルパス。

#### **2.2. 新ブック作成機能**

-   **2.2.1. 動的テンプレート選択**
    1.  `Settings`シート(D7)の`旧ブック_ファイルパス`で指定された旧ブックを開く。
    2.  旧ブック内の`Settings`シート(D8)で指定された`旧ブック_新ブック名判定アドレス`のセルの値を取得する。
    3.  `List`シートの`種類`列(F列)を検索し、2.で取得した値と一致する行を見つける。
    4.  一致した行の`ファイルパス`列(G列)から、使用すべきテンプレートファイルのパスを取得する。
-   **2.2.2. 新ブックの生成**
    1.  2.2.1で特定したテンプレートファイルをコピーする。
    2.  コピーしたファイルのファイル名を、`Settings`シートの`D18`（変電所-）, `D19`（TrB Ry-）, `D20`（日付）の値を連結した新しいファイル名（例: `神戸港変電所-6TrB Ry-2025.07.02.xls`）に変更して保存する。

#### **2.3. データ操作機能**

`Settings`シートの`A34`行以降に定義されたルールに基づき、`シートNo`の昇順でデータ操作を実行する。

-   **2.3.1. コピー処理**
    -   指定された旧ブックの`旧ブック_シート名`にある`旧ブック_コピー元アドレス`の範囲をコピーする。
    -   新ブックの`新ブック_シート名`にある`新ブック_コピー先アドレス`のセルを起点に、「すべて貼り付け（`PasteAll`）」を実行する。値、数式、書式、結合されたセルなど、すべてをそのままコピーする。
-   **2.3.2. 削除処理**
    -   新ブックの指定シートにある`新ブック_削除するアドレス`で指定されたセルの内容を削除（`ClearContents`）する。
    -   アドレスは、単一セル（例: `A1`）、範囲（例: `A1:B10`）、複数範囲（例: `A1,B5,C10:D12`）の形式に対応する。
    -   対象セルが結合されている場合でも、エラーなく内容の削除を実行する。
-   **2.3.4. 結合セルへの対応**
    -   全てのデータ操作（コピー、削除、入力）は、対象範囲に結合セルが含まれている場合でも、その結合状態を破壊することなく、エラーを発生させずに処理を完了させること。
-   **2.3.3. 入力処理**
    -   新ブックの指定シートにある`新ブック_入力するアドレス`で指定された各セルに、`新ブック_入力する内容`で指定された値を入力する。
    -   アドレスは、削除処理と同様に複数範囲の形式に対応する。複数セルに同一内容を入力する場合、`入力するアドレス`にカンマ区切りでセルを列挙する。

#### **2.4. ログ・エラー出力機能**

-   **2.4.1. ログ出力 (`Log`シート)**
    -   マクロ実行時に、まず`Log`シートの内容をクリアし、ヘッダー行（`日時`, `レベル`, `処理内容`, `詳細`）を書き込む。
    -   実行された主要な処理ステップごとに、日時、レベル(`INFO`)、処理内容、対象、結果（成功）を記録する。
    -   例: `2025/07/05 10:00:15 | INFO | コピー処理 | 旧:'統一表紙'!A4:CH62 -> 新:'共通(77kV以下)'!A4`
-   **2.4.2. エラー出力 (`ErrorLog`シート)**
    -   マクロ実行時に、まず`ErrorLog`シートの内容をクリアし、ヘッダー行（`日時`, `エラーレベル`, `処理シートNo`, `処理No.`, `エラー内容`, `エラー詳細`）を書き込む。
    -   処理中にエラーが発生した場合、処理を中断せず、次のステップへ進む。
    -   発生したエラーについて、以下の情報を`ErrorLog`シートに記録する。
        -   `日時`: エラー発生日時
        -   `エラーレベル`: エラーの重要度（例: `[致命的エラー]`, `[警告]`）。ユーザーが視覚的に識別しやすいように、レベルに応じてセルの背景色を変更する。
        -   `処理シートNo`: `Settings`シートで定義された処理シートNo。
        -   `処理No.`: `Settings`シートで定義された処理No.。
        -   `エラー内容`: どの処理でエラーが発生したか（例: `シート名の取得`）。
        -   `エラー詳細`: 具体的なエラーメッセージ（例: `指定されたシート '存在しないシート' が見つかりません。`）。

#### **2.5. 入力シート一括処理機能**

本ツールは、「入力」シートに定義された複数の処理対象を順次自動処理する機能を提供する。

-   **2.5.1. 処理フロー**
    -   入力シートの2行目以降を順次処理（1行目はヘッダー）
    -   各行のデータをSettingsシートのD7:D11に転記
    -   旧ブックから型式を取得してD22に設定
    -   XLOOKUP関数の計算完了を待機（最大10回リトライ、0.5秒間隔）
    -   計算完了後、データ移行処理を実行

-   **2.5.2. エラーハンドリング**
    -   各行の処理でエラーが発生した場合、該当行をスキップして次の行の処理を継続
    -   処理結果はLogシートとErrorLogシートに記録

#### **2.7. 完了通知機能**

-   **2.7.1. 完了メッセージ**
    -   「入力」シートのすべての行の処理が完了した後、ユーザーに完了を通知するメッセージボックスを表示する。
-   **2.7.2. 保存フォルダを開く**
    -   完了メッセージボックスには、最後に作成されたファイルの保存フォルダを開くか確認するオプション（はい/いいえ）を表示する。
    -   ユーザーが「はい」を選択した場合、該当のフォルダをエクスプローラーで開く。

### **3. 非機能要件**

-   **3.1. 信頼性**
    -   途中でエラーが発生しても、可能な限り処理を継続し、全ての処理命令を試みること。
    -   処理結果は、ログおよびエラーシートによって追跡可能であること。
-   **3.2. 運用・保守性**
    -   処理ルールの変更は、VBAコードを編集せず、「Settings」および「List」シートの編集のみで対応可能であること。
    -   コードは適切にモジュール分割され、可読性が高く、将来的な機能拡張が容易であること。

---
